import * as github from '@actions/github';
import * as core from '@actions/core';
import { Command } from './types';

export class GitHubService {
  private octokit: ReturnType<typeof github.getOctokit>;
  private context: typeof github.context;

  constructor(token: string) {
    this.octokit = github.getOctokit(token);
    this.context = github.context;
  }

  async postComment(issueNumber: number, imageUrls: string[], command: Command): Promise<void> {
    const imageType = command.type === 'concept' ? 'Concept Images' : 'Wireframe Images';
    
    // Build comment with images
    let commentBody = `## ${imageType}\n\n`;
    commentBody += `Generated ${imageUrls.length} ${imageType.toLowerCase()} based on the requirements:\n\n`;
    
    imageUrls.forEach((url, index) => {
      commentBody += `### ${imageType.split(' ')[0]} ${index + 1}\n`;
      commentBody += `![${imageType} ${index + 1}](${url})\n\n`;
    });
    
    commentBody += `---\n*Generated by @gen-visual*`;

    try {
      await this.octokit.rest.issues.createComment({
        owner: this.context.repo.owner,
        repo: this.context.repo.repo,
        issue_number: issueNumber,
        body: commentBody
      });
      
      core.info(`Posted comment with ${imageUrls.length} images to issue #${issueNumber}`);
    } catch (error) {
      core.error(`Failed to post comment: ${error}`);
      throw error;
    }
  }

  getIssueContext() {
    const payload = this.context.payload;
    
    return {
      issueNumber: payload.issue?.number || 0,
      issueBody: payload.issue?.body || '',
      commentBody: payload.comment?.body || payload.issue?.body || '',
      repository: `${this.context.repo.owner}/${this.context.repo.repo}`
    };
  }
}
